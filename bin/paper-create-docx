#!/usr/bin/env zsh
# Uses new signature in which 'PAPER_DIR' environment variable must be defined
cd "$PAPER_DIR"

source "$PAPER_DIR/paper-defs.zsh"
source "$PAPER_COMPONENTS/defs.zsh"

includes="$PAPER_DIR/build/converted-includes"

pc="$PAPER_COMPONENTS"

if [ $1 = "--full" ]; then
  shift
  
  figure_defs="text/includes.yaml"
  collect_dir="build/figures"
  mkdir -p $collect_dir
  # Collect figures into centralized directory
  figurator collect \
    $figure_defs \
    $collect_dir \
    ${FIGURE_SEARCH_DIRECTORIES}

  paper convert-includes $collect_dir $includes

  paper compile-refs
fi

paper rev-text \
| prepare-crossref \
| sed "s/º/°/g" \
| pandoc \
  --from markdown \
  --to docx+styles \
  --metadata-file=$PAPER_DIR/text/meta.yaml \
  --metadata includes-spec=$PAPER_DIR/text/includes.yaml \
  --metadata includes-dir=$includes \
  --metadata includes-only="tbl" \
  --reference-doc="$pc/templates/reference.docx" \
  --bibliography="$PAPER_DIR/build/references.bib" \
  --csl="$pc/agu.csl" \
  --filter "$pc/bin/figure-ref-filter" \
  --filter "$pc/bin/inline-figure-filter" \
  --filter pandoc-comments \
  --filter pandoc-crossref \
  --citeproc \
  -o "$PAPER_DIR/output/$name.docx" \
  $@

